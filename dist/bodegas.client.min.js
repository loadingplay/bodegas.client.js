"use strict";var BodegasClient=function(){this.app_public="1000",this.site_id=2,this.tag=null};BodegasClient.prototype.authenticate=function(a,b){var c=this;jQuery.get(Utils.getURL("authenticate",[a]),function(a){a.success&&(c.init(),b(c))})},BodegasClient.prototype.init=function(a){this.site_id=a,this.tag=new Tag(a),this.product=new Product(a)},function(a,b,c,d){var e="ecommerce",f={main:function(a){var b=new EcommerceFacade(a);return b.showProductList(),b},product_detail:function(a){var b=new EcommerceFacade(a);return b.showProductDetail(),b}};a.fn[e]=function(b,c){var d="main",e={app_public:0,products_per_page:10,base_url:"http://localhost:8520/",product_id:null};return"string"==typeof b?d=b:c=b,c=a.extend({},e,c),Utils.base_url=c.base_url,f[d](c)}}(jQuery,window,document);var EcommerceFacade=function(a){this.options=a,this.ecommerce=new BodegasClient,this.view=new ProductListView,this.product_view=new ProductDetailView};EcommerceFacade.prototype.showProductList=function(){var a=this;this.ecommerce.authenticate(this.options.app_public,function(){a.ecommerce.tag.listAll(function(b){a.view.renderTags(b)}),a.ecommerce.product.list(1,a.options.products_per_page,Utils.getUrlParameter("tag"),function(b){a.view.renderProducts(b)})})},EcommerceFacade.prototype.showProductDetail=function(){var a=this.options.product_id||Utils.getUrlParameter("id"),b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.product.get(a,function(a){b.product_view.render(a)})})};var Product=function(a){this.site_id=a};Product.prototype.list=function(a,b,c,d){var e="false",f=[];"function"==typeof c?d=c:e=c,(void 0===e||""===e)&&(e="false"),jQuery.get(Utils.getURL("product",["list",a,b,e]),function(a){void 0!==a.products&&(f=a.products),d(f)})},Product.prototype.get=function(a,b){jQuery.get(Utils.getURL("product",["get",a]),function(a){b(a)})};var ShoppingCart=function(){this.model=[],this.guid=this.generateGUID(),alert(this.generateGUID())};ShoppingCart.prototype.generateGUID=function(){var a=$.cookie("shopping-cart"),b=a;return(void 0===a||""===a)&&(b=Utils.createUUID(),$.cookie("shopping-cart",b)),b},ShoppingCart.prototype.getGUID=function(){return this.guid},ShoppingCart.prototype.addProduct=function(a,b,c){this.productExist(a)||this.model.push({id:a,price:b,name:c,quantity:0,total:b});for(var d=0;d<this.model.length;d++)this.model[d].id===a&&(this.model[d].quantity+=1,this.model[d].total=this.model[d].quantity*this.model[d].price)},ShoppingCart.prototype.removeProduct=function(a){for(var b=0;b<this.model.length;b++)if(a===this.model[b].id)return void this.model.splice(b,1)},ShoppingCart.prototype.removeOne=function(a){for(var b=0;b<this.model.length;b++)if(this.model[b].id===a)return this.model[b].quantity-=1,this.model[b].total=this.model[b].price*this.model[b].quantity,void(this.model[b].quantity<=0&&this.removeProduct(a))},ShoppingCart.prototype.getProducts=function(){return this.model},ShoppingCart.prototype.productExist=function(a){for(var b=parseInt(a),c=0;c<this.model.length;c++)if(parseInt(this.model[c].id)===b)return!0;return!1},ShoppingCart.prototype.getTotal=function(){for(var a=0,b=0;b<this.model.length;b++){var c=this.model[b];a+=c.price*c.quantity}return a},ShoppingCart.prototype.loadCart=function(a){var b=void 0===a?$.noop:a;$.get(Utils.getURL("cart",["load",this.getGUID()]),function(a){this.model=a,b(a)})};var Tag=function(a){this.site_id=a};Tag.prototype.listAll=function(a){$.get(Utils.getURL("tag",["list_all"]),function(b){a(b.tags)})};var Utils={base_url:"http://apibodegas.ondev.today/",strEndsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},getURL:function(a,b){Utils.strEndsWith(Utils.base_url,"/")||(Utils.base_url+="/");var c=Utils.base_url+a+"/";return b&&(c+=b.join("/")),c},render:function(a,b){var c=a;for(var d in b)for(var e=new RegExp("\\{{2}(\\s|)"+d+"(\\s|)\\}{2}");c.split(e).length>1;)c=c.replace(e,b[d]);return c},getUrlParameter:function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}},createUUID:function(){for(var a=[],b="0123456789abcdef",c=0;36>c;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-";var d=a.join("");return d}},ProductDetailView=function(){this.template="",this.initTemplates()};ProductDetailView.prototype.initTemplates=function(){this.template=$.trim($("#product_detail").html())},ProductDetailView.prototype.render=function(a){var b=$(".container"),c=$(Utils.render(this.template,a)),d=$(".image",c);this.renderImages(d,a.id),b.append(c)},ProductDetailView.prototype.renderImages=function(a,b){var c=this,d="",e=null,f=Utils.getURL("product",["images",b]),g=0;$.get(f,function(b){"string"==typeof b&&(b=$.parseJSON(b)),a.each(function(){b.images.length>g&&(d=b.images[0].thumb_500,e=$(a[g]),c.loadImageToElement(d,e)),g++})})},ProductDetailView.prototype.loadImageToElement=function(a,b){var c=b.clone();c.load(function(){b.replaceWith(c)}),c.attr("src",a)};var ProductListView=function(){this.tag_template="",this.product_template="",this.initTemplates()};ProductListView.prototype.initTemplates=function(){this.tag_template=$.trim($("#tag_template").html()),this.product_template=$.trim($("#product_template").html())},ProductListView.prototype.renderTags=function(a){for(var b=$(".menu ul"),c=0;c<a.length;c++){var d=a[c],e=Utils.render(this.tag_template,d);b.append(e)}},ProductListView.prototype.renderProducts=function(a){for(var b=$(".products"),c=0;c<a.length;c++){var d=a[c],e=$(Utils.render(this.product_template,d));this.renderProductImage($(".product-image",e),d.id),b.append(e)}},ProductListView.prototype.renderProductImage=function(a,b){var c=Utils.getURL("product",["images",b]);$.get(c,function(b){if("string"==typeof b&&(b=$.parseJSON(b)),b.images.length>0){var c=b.images[0].thumb_200,d=a.clone();d.load(function(){a.replaceWith(d)}),d.attr("src",c)}})};var ShoppingCartView=function(a){this.controller=void 0===a?new ShoppingCart:a,this.options={cartSelector:".shopping-cart",addToCartbutton:".add-to-cart",removeFromCart:".remove-from-cart",addOne:".add-one",removeOne:".remove-one"},this.$cart_div=$(".shopping-cart"),this.cart_item_template=$("#shopping-cart-product").html(),this.total_template=$("#shopping-cart-total").html(),this.init()};ShoppingCartView.prototype.init=function(){var a=this;$(document).on("click",this.options.addToCartbutton,function(){a.addToCartClick($(this)),a.render()}),$(document).on("click",this.options.addOne,function(){a.addOneClick($(this)),a.render()}),$(document).on("click",this.options.removeOne,function(){a.removeOne($(this)),a.render()}),$(document).on("click",this.options.removeFromCart,function(){a.removeProduct($(this)),a.render()})},ShoppingCartView.prototype.addOneClick=function(a){var b=a.attr("product-id");this.controller.addProduct(b)},ShoppingCartView.prototype.addToCartClick=function(a){var b=a.attr("product-id"),c=a.attr("product-name"),d=a.attr("product-price");this.controller.addProduct(b,d,c)},ShoppingCartView.prototype.removeOne=function(a){var b=a.attr("product-id");this.controller.removeOne(b)},ShoppingCartView.prototype.removeProduct=function(a){var b=a.attr("product-id");this.controller.removeProduct(b)},ShoppingCartView.prototype.render=function(){this.$cart_div.html(""),this.renderProducts(this.$cart_div,this.cart_item_template),this.renderTotal(this.$cart_div)},ShoppingCartView.prototype.renderProducts=function(a,b){for(var c=this.controller.getProducts(),d=0;d<c.length;d++){var e=Utils.render(b,c[d]);a.append(e)}},ShoppingCartView.prototype.renderTotal=function(a){var b=Utils.render(this.total_template,{total:this.controller.getTotal()});a.append(b)};