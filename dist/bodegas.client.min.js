"use strict";var BodegasClient=function(a){this.app_public="1000",this.site_id=2,this.tag=null,this.checkout_url=void 0===a?"":a};BodegasClient.prototype.authenticate=function(a,b){var c=this;jQuery.get(Utils.getURL("authenticate",[a]),function(d){d.success&&(c.init(a),b(c))})},BodegasClient.prototype.init=function(a){this.site_id=a,this.tag=new Tag(a),this.product=new Product(a),this.cart=new ShoppingCart(a,this.checkout_url)};var ExtraInfo=function(a){this.model={},this.cart_id=a};ExtraInfo.prototype.set_data=function(a,b){return this._isValidIndex(a)?(this.model[a]=b,this.synchronize(),!0):!1},ExtraInfo.prototype.get_data=function(a){try{return this.model[a]}catch(b){}return!1},ExtraInfo.prototype._isValidIndex=function(a){return"string"==typeof a?!0:isNaN(parseInt(a))?!1:!0},ExtraInfo.prototype.synchronize=function(){var a=JSON.stringify(this.model);$.post(Utils.getURL("cart",["extra_info",this.cart_id]),{data:a},function(){})},function(a,b,c,d){var e,f="ecommerce",g=1,h={main:function(a){return e=new EcommerceFacade(a),e.showProductList(g),g++,e},product_detail:function(a){var b=new EcommerceFacade(a);return b.showProductDetail(),b},load_more:function(){return e.showProductList(g),g++,e},set_data:function(a){return e.setData(a),e}};a.fn[f]=function(b,c){var d="main",e={app_public:0,products_per_page:12,base_url:"http://localhost:8520/",checkout_url:"http://localhost:8522",product_id:null,ignore_stock:!1};return"string"==typeof b?d=b:c=b,"set_data"!==d&&(c=a.extend({},e,c),Utils.base_url=c.base_url),h[d](c)}}(jQuery,window,document);var EcommerceFacade=function(a){var b=this;this.page=1,this.options=a,this.ecommerce=new BodegasClient(this.options.checkout_url),this.view=new ProductListView,this.product_view=new ProductDetailView,this.view.onScrollEnd(function(){b.page++,b.showProductList(b.page)})};EcommerceFacade.prototype.showProductList=function(a){var b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.tag.listAll(function(a){b.view.renderTags(a)});b.ecommerce.product.list;b.options.ignore_stock?b.ecommerce.product.listIgnoringStock(a,b.options.products_per_page,Utils.getUrlParameter("tag"),function(a){b.view.renderProducts(a)}):b.ecommerce.product.list(a,b.options.products_per_page,Utils.getUrlParameter("tag"),function(a){b.view.renderProducts(a)})})},EcommerceFacade.prototype.showProductDetail=function(){var a=this.options.product_id||Utils.getUrlParameter("id"),b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.product.get(a,function(a){b.product_view.render(a)})})},EcommerceFacade.prototype.setData=function(a){if("object"==typeof a)for(var b in a)this.ecommerce.cart.extra_info.set_data(b,a[b]);else"string"==typeof a?this.ecommerce.cart.extra_info.set_data("extra",a):this.ecommerce.cart.extra_info.set_data("extra",""+a)};var Product=function(a){this.site_id=a};Product.prototype.list=function(a,b,c,d){this._list(a,b,!1,c,d)},Product.prototype.listIgnoringStock=function(a,b,c,d){this._list(a,b,!0,c,d)},Product.prototype.get=function(a,b){jQuery.get(Utils.getURL("product",["get",a]),function(a){b(a)})},Product.prototype._list=function(a,b,c,d,e){var f="false",g=[];"function"==typeof d?e=d:f=d,(void 0===f||""===f)&&(f="false"),jQuery.get(Utils.getURL("product",["list",this.site_id,a,b,f,c]),function(a){void 0!==a.products&&(g=a.products),e(g)})};var ShoppingCart=function(a,b){this.extra_info=new ExtraInfo(1),this.model=[],this.guid=this.generateGUID(),this.checkout_url=void 0===b?"":b,this.site_id=void 0===a?2:a,this.view=new ShoppingCartView(this),this.loadCart()};ShoppingCart.prototype.generateGUID=function(){var a=$.cookie("shopping-cart"),b=a;return(void 0===a||""===a)&&(b=Utils.createUUID(),$.cookie("shopping-cart",b)),this.extra_info.cart_id=b,b},ShoppingCart.prototype.getGUID=function(){return this.guid},ShoppingCart.prototype.getCheckoutUrl=function(){return this.checkout_url},ShoppingCart.prototype.getSiteId=function(){return this.site_id},ShoppingCart.prototype.saveModel=function(){$.post(Utils.getURL("cart",["save",this.guid]),{json_data:JSON.stringify(this.model)},function(){})},ShoppingCart.prototype.recalcTotals=function(){for(var a=0;a<this.model.length;a++){var b=this.model[a];b.total=b.quantity*b.price,b.upp_total=b.quantity*b.upp}},ShoppingCart.prototype.addProduct=function(a,b,c,d){this.productExist(a)||this.model.push({id:parseInt(a),price:b,name:c,quantity:0,upp:d,upp_total:d,total:b});for(var e=0;e<this.model.length;e++)if(this.model[e].id===parseInt(a))return this.model[e].quantity+=1,this.model[e].total=this.model[e].quantity*this.model[e].price,this.model[e].upp_total=this.model[e].quantity*this.model[e].upp,void this.saveModel()},ShoppingCart.prototype.removeProduct=function(a){for(var b=0;b<this.model.length;b++)if(parseInt(a)===this.model[b].id)return this.model.splice(b,1),void this.saveModel()},ShoppingCart.prototype.removeOne=function(a){for(var b=0;b<this.model.length;b++)if(this.model[b].id===parseInt(a))return this.model[b].quantity-=1,this.model[b].total=this.model[b].price*this.model[b].quantity,this.model[b].upp_total=this.model[b].quantity*this.model[b].upp,this.model[b].quantity<=0&&this.removeProduct(a),void this.saveModel()},ShoppingCart.prototype.getProducts=function(){return this.model},ShoppingCart.prototype.productExist=function(a){for(var b=parseInt(a),c=0;c<this.model.length;c++)if(parseInt(this.model[c].id)===b)return!0;return!1},ShoppingCart.prototype.getTotal=function(){for(var a=0,b=0;b<this.model.length;b++){var c=this.model[b];a+=c.price*c.quantity}return a},ShoppingCart.prototype.getUnitsTotal=function(){for(var a=0,b=0;b<this.model.length;b++){var c=this.model[b];a+=c.quantity}return a},ShoppingCart.prototype.getUPPTotal=function(){for(var a=0,b=0;b<this.model.length;b++){var c=this.model[b];a+=parseInt(c.upp_total)}return a},ShoppingCart.prototype.loadCart=function(a){var b=this,c=void 0===a?$.noop:a;$.get(Utils.getURL("cart",["load",this.getGUID()]),function(a){return a.expired?($.removeCookie("shopping-cart"),b.guid=b.generateGUID(),void c([])):(b.model=a.products,b.recalcTotals(),b.view.render(),void c(a))})};var Tag=function(a){this.site_id=a};Tag.prototype.listAll=function(a){$.get(Utils.getURL("tag",["list_all",this.site_id]),function(b){a(b.tags)})};var Utils={base_url:"http://apibodegas.ondev.today/",strEndsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},getURL:function(a,b){Utils.strEndsWith(Utils.base_url,"/")||(Utils.base_url+="/");var c=Utils.base_url+a+"/";return b&&(c+=b.join("/")),c},friendly:function(a){return Utils.URLBeautify(a)},extract_data:function(a,b){a=$.trim(a);var c=[a],d=function(a){return a},e="";return-1!==a.indexOf("|")&&(c=a.split("|"),a=c[0],d=Utils[c[1]]),e=b[$.trim(a)],e=void 0===e?"":e,d(e)},render:function(a,b){if(void 0===a)return"";for(var c="",d=a.split("{{"),e=0;e<d.length;e++){var f=d[e].split("}}")[0],g=d[e].split("}}")[1];g=void 0===g?f:g;var h=Utils.extract_data(f,b);c+=h,c+=g}return c},getUrlParameter:function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}},createUUID:function(){for(var a=[],b="0123456789abcdef",c=0;36>c;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-";var d=a.join("");return d},formatMoney:function(a,b,c,d){b=isNaN(b=Math.abs(b))?0:b,c=void 0===c?",":c,d=void 0===d?".":d;var e=0>a?"-":"",f=parseInt(a=Math.abs(+a||0).toFixed(b))+"",g=(g=f.length)>3?g%3:0;return"$"+e+(g?f.substr(0,g)+d:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+d)+(b?c+Math.abs(a-f).toFixed(b).slice(2):"")},processPrice:function(a){$(".money",a).each(function(){var a=$(this).html();$(this).html(Utils.formatMoney(a))})},URLBeautify:function(a){a=a.toLowerCase();var b=a.split(" ");return a=b.join("_"),a=a.split("ñ").join("n"),a=a.split("á").join("a"),a=a.split("é").join("e"),a=a.split("í").join("i"),a=a.split("ó").join("o"),a=a.split("ú").join("u"),a=a.split("?").join(""),a=a.split("%").join(""),a=a.split("$").join(""),a=a.split("&").join(""),a=a.split(",").join(""),a=a.split(".").join(""),a=a.split("/").join("")}},ProductDetailView=function(){this.template="",this.initTemplates()};ProductDetailView.prototype.initTemplates=function(){this.template=$.trim($("#product_detail").html())},ProductDetailView.prototype.render=function(a){var b=$(".container"),c=$(Utils.render(this.template,a)),d=$(".image",c);this.renderImages(d,a.id),b.append(c),Utils.processPrice(c)},ProductDetailView.prototype.renderImages=function(a,b){var c=this,d="",e=null,f=Utils.getURL("product",["images",b]),g=parseInt(a.attr("max-images"));g=isNaN(g)?1:g,$.get(f,function(b){"string"==typeof b&&(b=$.parseJSON(b)),0===g&&(g=b.images.length);for(var f=0;g>f;f++)b.images.length>f&&(e=a.clone(),e.insertAfter(a),d=b.images[f].thumb_500,c.loadImageToElement(d,e));a.remove()})},ProductDetailView.prototype.loadImageToElement=function(a,b){var c=b.clone();c.load(function(){b.replaceWith(c)}),c.fadeOut(function(){c.attr("src",a)}),c.fadeIn()};var ProductListView=function(){this.all_products_loaded=!1,this.loading_products=!1,this.tag_template="",this.product_template="",this.site_search_template="",this.on_scroll_end=$.noop,this.site_search=$("#site_search"),this.renderLoading(),this.initTemplates()};ProductListView.prototype.initTemplates=function(){this.tag_template=$.trim($("#tag_template").html()),this.product_template=$.trim($("#product_template").html()),this.site_search_template=$.trim($("#site_search_template").html()),this.init()},ProductListView.prototype.init=function(){var a=this;this.renderSiteSearch(this.site_search_template),$(document).on("scroll",function(){if(!a.loading_products){var b=$(".products");$(".spinner",b);$(window).scrollTop()>=$(document).height()-$(window).height()-400&&(a.loading_products=!0,a.on_scroll_end())}})},ProductListView.prototype.onScrollEnd=function(a){this.on_scroll_end=a},ProductListView.prototype.renderTags=function(a){if(void 0!==a)for(var b=$(".menu ul"),c=0;c<a.length;c++){var d=a[c],e=Utils.render(this.tag_template,d);b.append(e)}},ProductListView.prototype.renderProducts=function(a){var b=$(".products");if(a.length>0){for(var c=0;c<a.length;c++){var d=a[c],e=$(Utils.render(this.product_template,d));Utils.processPrice(e),this.renderProductImage($(".product-image",e),d.id,$(".product-image-href",e)),0===d.balance_units&&this.showSoldOut(e),b.append(e)}this.renderLoading()}else this.all_products_loaded=!0,this.removeLoading()},ProductListView.prototype.showSoldOut=function(a){$(".add-to-cart",a).addClass("product-sold-out"),$(".add-to-cart",a).html("Agotado"),$(".add-to-cart",a).val("Agotado")},ProductListView.prototype.removeLoading=function(){var a=$(".products");$(".spinner",a).remove()},ProductListView.prototype.renderLoading=function(){if(this.removeLoading(),!this.all_products_loaded){var a=$(".products");a.append($("#product_loading").html())}this.loading_products=!1},ProductListView.prototype.renderProductImage=function(a,b,c){var d=Utils.getURL("product",["images",b]);$.get(d,function(b){if("string"==typeof b&&(b=$.parseJSON(b)),b.images.length>0){var d=b.images[0].thumb_500,e=a.clone();e.load(function(){a.replaceWith(e)}),e.fadeOut(function(){c.length>0&&c.attr("href",d),e.attr("src",d)}),e.fadeIn()}})},ProductListView.prototype.renderSiteSearch=function(a){this.site_search.append(a)};var ShoppingCartView=function(a){this.controller=void 0===a?new ShoppingCart:a,this.options={cartSelector:".shopping-cart",addToCartbutton:".add-to-cart",removeFromCart:".remove-from-cart",addOne:".add-one",removeOne:".remove-one"},this.$cart_div=$(".shopping-cart"),this.$cart_container=$(".cart-container"),this.$total_items=$("#total_items"),this.$total_cart=$("#total_cart"),this.cart_item_template=$("#shopping-cart-product").html(),this.total_template=$("#shopping-cart-total").html(),this.checkout_template=$("#shopping-cart-checkout-form").html(),this.units_total_template=$("#shopping-cart-units-total").html(),this.total_items_template=$("#total_items_template").html(),this.total_cart_template=$("#total_cart_template").html(),this.renderLoading(),this.init()};ShoppingCartView.prototype.init=function(){var a=this;$(document).on("click",this.options.addToCartbutton,function(b){b.preventDefault(),$(this).hasClass("product-sold-out")||(a.addToCartClick($(this)),a.render())}),$(document).on("click",this.options.addOne,function(b){b.preventDefault(),a.addOneClick($(this)),a.render()}),$(document).on("click",this.options.removeOne,function(b){b.preventDefault(),a.removeOne($(this)),a.render()}),$(document).on("click",this.options.removeFromCart,function(b){b.preventDefault(),a.removeProduct($(this)),a.render()}),this.render()},ShoppingCartView.prototype.removeLoading=function(){var a=$(".container");$(".spinner",a).remove()},ShoppingCartView.prototype.renderLoading=function(){if(this.removeLoading(),!this.allcontainerLoaded){var a=$(".container");a.append($("#product_loading").html())}},ShoppingCartView.prototype.addOneClick=function(a){var b=a.attr("product-id");this.controller.addProduct(b)},ShoppingCartView.prototype.addToCartClick=function(a){var b=a.attr("product-id"),c=a.attr("product-name"),d=a.attr("product-price"),e=a.attr("product-upp");this.controller.addProduct(b,d,c,e)},ShoppingCartView.prototype.removeOne=function(a){var b=a.attr("product-id");this.controller.removeOne(b)},ShoppingCartView.prototype.removeProduct=function(a){var b=a.attr("product-id");this.controller.removeProduct(b)},ShoppingCartView.prototype.render=function(){this.$cart_div.html(""),this.$total_cart.html(""),this.renderProducts(this.$cart_div,this.cart_item_template),this.renderTotal(this.$cart_div,this.$total_cart),this.renderUnitsTotal(this.$cart_div,this.$total_items),this.renderCheckoutData(this.$cart_div)},ShoppingCartView.prototype.renderCheckoutData=function(a){try{var b=Utils.render(this.checkout_template,{site_id:this.controller.getSiteId(),checkout_url:this.controller.getCheckoutUrl(),cart_id:this.controller.getGUID()});$(".checkout-form").html(b)}catch(c){}},ShoppingCartView.prototype.renderProducts=function(a,b){for(var c=this.controller.getProducts(),d=0;d<c.length;d++){var e=$(Utils.render(b,c[d]));this.removeLoading(),a.append(e),Utils.processPrice(e)}},ShoppingCartView.prototype.renderTotal=function(a,b){try{var c=$(Utils.render(this.total_template,{total:this.controller.getTotal()}));Utils.processPrice(c),a.append(c);var d=$(Utils.render(this.total_cart_template,{total:this.controller.getTotal()}));Utils.processPrice(d),b.html(d)}catch(e){}},ShoppingCartView.prototype.renderUnitsTotal=function(a,b){try{var c=$(Utils.render(this.units_total_template,{units_total:this.controller.getUnitsTotal(),upp_total:this.controller.getUPPTotal()}));Utils.processPrice(c),$(".units-total").html(c);var d=$(Utils.render(this.total_items_template,{total:this.controller.getUnitsTotal()}));b.html(d)}catch(e){}};