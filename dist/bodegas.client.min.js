"use strict";var BodegasClient=function(){this.app_public="1000",this.site_id=2,this.tag=null};BodegasClient.prototype.authenticate=function(a,b){var c=this;jQuery.get(Utils.getURL("authenticate",[a]),function(a){a.success&&(c.init(),b(c))})},BodegasClient.prototype.init=function(a){this.site_id=a,this.tag=new Tag(a),this.product=new Product(a)},function(a,b,c,d){var e="ecommerce",f={main:function(a){var b=new EcommerceFacade(a);return b.showProductList(),b},product_detail:function(a){var b=new EcommerceFacade(a);return b.showProductDetail(),b}};a.fn[e]=function(b,c){var d="main",e={app_public:0,products_per_page:10,base_url:"http://localhost:8520/",product_id:null};return"string"==typeof b?d=b:c=b,c=a.extend({},e,c),Utils.base_url=c.base_url,f[d](c)}}(jQuery,window,document);var EcommerceFacade=function(a){this.options=a,this.ecommerce=new BodegasClient,this.view=new ProductListView,this.product_view=new ProductDetailView};EcommerceFacade.prototype.showProductList=function(){var a=this;this.ecommerce.authenticate(this.options.app_public,function(){a.ecommerce.tag.listAll(function(b){a.view.renderTags(b)}),a.ecommerce.product.list(1,a.options.products_per_page,Utils.getUrlParameter("tag"),function(b){a.view.renderProducts(b)})})},EcommerceFacade.prototype.showProductDetail=function(){var a=this.options.product_id||Utils.getUrlParameter("id"),b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.product.get(a,function(a){b.product_view.render(a)})})};var Product=function(a){this.site_id=a};Product.prototype.list=function(a,b,c,d){var e="false";"function"==typeof c?d=c:e=c,(void 0===e||""===e)&&(e="false"),jQuery.get(Utils.getURL("product",["list",a,b,e]),function(a){d(a.products)})},Product.prototype.get=function(a,b){jQuery.get(Utils.getURL("product",["get",a]),function(a){b(a)})};var Tag=function(a){this.site_id=a};Tag.prototype.listAll=function(a){$.get(Utils.getURL("tag",["list_all"]),function(b){a(b.tags)})};var Utils={base_url:"http://localhost:8520/",getURL:function(a,b){var c=Utils.base_url+a+"/";return b&&(c+=b.join("/")),c},render:function(a,b){var c=a;for(var d in b)for(var e=new RegExp("\\{{2}(\\s|)"+d+"(\\s|)\\}{2}");c.split(e).length>1;)c=c.replace(e,b[d]);return c},getUrlParameter:function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}}},ProductDetailView=function(){this.template="",this.initTemplates()};ProductDetailView.prototype.initTemplates=function(){this.template=$.trim($("#product_detail").html())},ProductDetailView.prototype.render=function(a){var b=$(".container"),c=$(Utils.render(this.template,a)),d=$(".image",c);this.renderImages(d,a.id),b.append(c)},ProductDetailView.prototype.renderImages=function(a,b){var c=this,d="",e=null,f=Utils.getURL("product",["images",b]),g=0;$.get(f,function(b){"string"==typeof b&&(b=$.parseJSON(b)),a.each(function(){b.images.length>g&&(d=b.images[0].thumb_500,e=$(a[g]),c.loadImageToElement(d,e)),g++})})},ProductDetailView.prototype.loadImageToElement=function(a,b){var c=b.clone();c.load(function(){b.replaceWith(c)}),c.attr("src",a)};var ProductListView=function(){this.tag_template="",this.product_template="",this.initTemplates()};ProductListView.prototype.initTemplates=function(){this.tag_template=$.trim($("#tag_template").html()),this.product_template=$.trim($("#product_template").html())},ProductListView.prototype.renderTags=function(a){for(var b=$(".menu ul"),c=0;c<a.length;c++){var d=a[c],e=Utils.render(this.tag_template,d);b.append(e)}},ProductListView.prototype.renderProducts=function(a){for(var b=$(".products"),c=0;c<a.length;c++){var d=a[c],e=$(Utils.render(this.product_template,d));this.renderProductImage($(".product-image",e),d.id),b.append(e)}},ProductListView.prototype.renderProductImage=function(a,b){var c=Utils.getURL("product",["images",b]);$.get(c,function(b){if("string"==typeof b&&(b=$.parseJSON(b)),b.images.length>0){var c=b.images[0].thumb_200,d=a.clone();d.load(function(){a.replaceWith(d)}),d.attr("src",c)}})};