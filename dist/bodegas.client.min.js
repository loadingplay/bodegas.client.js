"use strict";var BodegasClient=function(){this.app_public="1000",this.site_id=2,this.tag=null};BodegasClient.prototype.authenticate=function(a,b){var c=this;jQuery.get(Utils.getURL("authenticate",[a]),function(d){d.success&&(c.init(a),b(c))})},BodegasClient.prototype.init=function(a){this.site_id=a,this.tag=new Tag(a),this.product=new Product(a),this.cart=new ShoppingCart},function(a,b,c,d){var e="ecommerce",f=1,g={main:function(a){var b=new EcommerceFacade(a);return b.showProductList(f),f++,b},product_detail:function(a){var b=new EcommerceFacade(a);return b.showProductDetail(),b},load_more:function(a){var b=new EcommerceFacade(a);return b.showProductList(f),f++,b}};a.fn[e]=function(b,c){var d="main",e={app_public:0,products_per_page:12,base_url:"http://localhost:8520/",product_id:null};return"string"==typeof b?d=b:c=b,c=a.extend({},e,c),Utils.base_url=c.base_url,g[d](c)}}(jQuery,window,document);var EcommerceFacade=function(a){this.options=a,this.ecommerce=new BodegasClient,this.view=new ProductListView,this.product_view=new ProductDetailView};EcommerceFacade.prototype.showProductList=function(a){var b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.tag.listAll(function(a){b.view.renderTags(a)}),b.ecommerce.product.list(a,b.options.products_per_page,Utils.getUrlParameter("tag"),function(a){b.view.renderProducts(a)})})},EcommerceFacade.prototype.showProductDetail=function(){var a=this.options.product_id||Utils.getUrlParameter("id"),b=this;this.ecommerce.authenticate(this.options.app_public,function(){b.ecommerce.product.get(a,function(a){b.product_view.render(a)})})};var Product=function(a){this.site_id=a};Product.prototype.list=function(a,b,c,d){var e="false",f=[];"function"==typeof c?d=c:e=c,(void 0===e||""===e)&&(e="false"),jQuery.get(Utils.getURL("product",["list",this.site_id,a,b,e]),function(a){void 0!==a.products&&(f=a.products),d(f)})},Product.prototype.get=function(a,b){jQuery.get(Utils.getURL("product",["get",a]),function(a){b(a)})};var ShoppingCart=function(){this.model=[],this.guid=this.generateGUID(),this.webpay_url="",this.success_url="",this.failure_url="",this.session_id="",this.checkout_url="",this.view=new ShoppingCartView(this),this.loadCart()};ShoppingCart.prototype.generateGUID=function(){var a=$.cookie("shopping-cart"),b=a;return(void 0===a||""===a)&&(b=Utils.createUUID(),$.cookie("shopping-cart",b)),b},ShoppingCart.prototype.getGUID=function(){return this.guid},ShoppingCart.prototype.getWebpayUrl=function(){return this.webpay_url},ShoppingCart.prototype.getSuccessUrl=function(){return this.success_url},ShoppingCart.prototype.getFailureUrl=function(){return this.failure_url},ShoppingCart.prototype.getSessionId=function(){return this.session_id},ShoppingCart.prototype.getCheckoutUrl=function(){return this.checkout_url},ShoppingCart.prototype.saveModel=function(){$.post(Utils.getURL("cart",["save",this.guid]),{json_data:JSON.stringify(this.model)},function(){})},ShoppingCart.prototype.recalcTotals=function(){for(var a=0;a<this.model.length;a++){var b=this.model[a];b.total=b.quantity*b.price}},ShoppingCart.prototype.addProduct=function(a,b,c){this.productExist(a)||this.model.push({id:parseInt(a),price:b,name:c,quantity:0,total:b});for(var d=0;d<this.model.length;d++)if(this.model[d].id===parseInt(a))return this.model[d].quantity+=1,this.model[d].total=this.model[d].quantity*this.model[d].price,void this.saveModel()},ShoppingCart.prototype.removeProduct=function(a){for(var b=0;b<this.model.length;b++)if(parseInt(a)===this.model[b].id)return this.model.splice(b,1),void this.saveModel()},ShoppingCart.prototype.removeOne=function(a){for(var b=0;b<this.model.length;b++)if(this.model[b].id===parseInt(a))return this.model[b].quantity-=1,this.model[b].total=this.model[b].price*this.model[b].quantity,this.model[b].quantity<=0&&this.removeProduct(a),void this.saveModel()},ShoppingCart.prototype.getProducts=function(){return this.model},ShoppingCart.prototype.productExist=function(a){for(var b=parseInt(a),c=0;c<this.model.length;c++)if(parseInt(this.model[c].id)===b)return!0;return!1},ShoppingCart.prototype.getTotal=function(){for(var a=0,b=0;b<this.model.length;b++){var c=this.model[b];a+=c.price*c.quantity}return a},ShoppingCart.prototype.loadCart=function(a){var b=this,c=void 0===a?$.noop:a;$.get(Utils.getURL("cart",["load",this.getGUID()]),function(a){b.model=a.products,b.webpay_url=a.webpay_url,b.session_id=a.session_id,b.success_url=a.success_url,b.failure_url=a.failure_url,b.checkout_url=a.checkout_url,b.recalcTotals(),b.view.render(),c(a)})};var Tag=function(a){this.site_id=a};Tag.prototype.listAll=function(a){$.get(Utils.getURL("tag",["list_all",this.site_id]),function(b){a(b.tags)})};var Utils={base_url:"http://apibodegas.ondev.today/",strEndsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},getURL:function(a,b){Utils.strEndsWith(Utils.base_url,"/")||(Utils.base_url+="/");var c=Utils.base_url+a+"/";return b&&(c+=b.join("/")),c},render:function(a,b){if(void 0===a)return"";var c=a;for(var d in b)for(var e=new RegExp("\\{{2}(\\s|)"+d+"(\\s|)\\}{2}");c.split(e).length>1;)c=c.replace(e,b[d]);return c},getUrlParameter:function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}},createUUID:function(){for(var a=[],b="0123456789abcdef",c=0;36>c;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-";var d=a.join("");return d},formatMoney:function(a,b,c,d){b=isNaN(b=Math.abs(b))?0:b,c=void 0===c?",":c,d=void 0===d?".":d;var e=0>a?"-":"",f=parseInt(a=Math.abs(+a||0).toFixed(b))+"",g=(g=f.length)>3?g%3:0;return"$ "+e+(g?f.substr(0,g)+d:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+d)+(b?c+Math.abs(a-f).toFixed(b).slice(2):"")},processPrice:function(a){$(".money",a).each(function(){var a=$(this).html();$(this).html(Utils.formatMoney(a))})}},ProductDetailView=function(){this.template="",this.initTemplates()};ProductDetailView.prototype.initTemplates=function(){this.template=$.trim($("#product_detail").html())},ProductDetailView.prototype.render=function(a){var b=$(".container"),c=$(Utils.render(this.template,a)),d=$(".image",c);this.renderImages(d,a.id),b.append(c),Utils.processPrice(c)},ProductDetailView.prototype.renderImages=function(a,b){var c=this,d="",e=null,f=Utils.getURL("product",["images",b]),g=0;$.get(f,function(b){"string"==typeof b&&(b=$.parseJSON(b)),a.each(function(){b.images.length>g&&(d=b.images[0].thumb_500,e=$(a[g]),c.loadImageToElement(d,e)),g++})})},ProductDetailView.prototype.loadImageToElement=function(a,b){var c=b.clone();c.load(function(){b.replaceWith(c)}),c.attr("src",a)};var ProductListView=function(){this.tag_template="",this.product_template="",this.initTemplates()};ProductListView.prototype.initTemplates=function(){this.tag_template=$.trim($("#tag_template").html()),this.product_template=$.trim($("#product_template").html())},ProductListView.prototype.renderTags=function(a){if(void 0!==a)for(var b=$(".menu ul"),c=0;c<a.length;c++){var d=a[c],e=Utils.render(this.tag_template,d);b.append(e)}},ProductListView.prototype.renderProducts=function(a){for(var b=$(".products"),c=0;c<a.length;c++){var d=a[c],e=$(Utils.render(this.product_template,d));Utils.processPrice(e),this.renderProductImage($(".product-image",e),d.id),b.append(e)}},ProductListView.prototype.renderProductImage=function(a,b){var c=Utils.getURL("product",["images",b]);$.get(c,function(b){if("string"==typeof b&&(b=$.parseJSON(b)),b.images.length>0){var c=b.images[0].thumb_200,d=a.clone();d.load(function(){a.replaceWith(d)}),d.attr("src",c)}})};var ShoppingCartView=function(a){this.controller=void 0===a?new ShoppingCart:a,this.options={cartSelector:".shopping-cart",addToCartbutton:".add-to-cart",removeFromCart:".remove-from-cart",addOne:".add-one",removeOne:".remove-one"},this.$cart_div=$(".shopping-cart"),this.$cart_container=$(".cart-container"),this.cart_item_template=$("#shopping-cart-product").html(),this.total_template=$("#shopping-cart-total").html(),this.init()};ShoppingCartView.prototype.init=function(){var a=this;$(document).on("click",this.options.addToCartbutton,function(b){b.preventDefault(),a.addToCartClick($(this)),a.render()}),$(document).on("click",this.options.addOne,function(b){b.preventDefault(),a.addOneClick($(this)),a.render()}),$(document).on("click",this.options.removeOne,function(b){b.preventDefault(),a.removeOne($(this)),a.render()}),$(document).on("click",this.options.removeFromCart,function(b){b.preventDefault(),a.removeProduct($(this)),a.render()}),this.render()},ShoppingCartView.prototype.addOneClick=function(a){var b=a.attr("product-id");this.controller.addProduct(b)},ShoppingCartView.prototype.addToCartClick=function(a){var b=a.attr("product-id"),c=a.attr("product-name"),d=a.attr("product-price");this.controller.addProduct(b,d,c)},ShoppingCartView.prototype.removeOne=function(a){var b=a.attr("product-id");this.controller.removeOne(b)},ShoppingCartView.prototype.removeProduct=function(a){var b=a.attr("product-id");this.controller.removeProduct(b)},ShoppingCartView.prototype.render=function(){this.$cart_div.html(""),this.renderProducts(this.$cart_div,this.cart_item_template),this.renderTotal(this.$cart_div),this.renderCheckoutData(this.$cart_div,this.$cart_container)},ShoppingCartView.prototype.renderCheckoutData=function(a,b){var c=this.controller.getGUID(),d=this.controller.getSessionId(),e=this.controller.getFailureUrl(),f=this.controller.getSuccessUrl(),g=this.controller.getWebpayUrl(),h=this.controller.getCheckoutUrl();$("input[name=order_id]",b).val(c),$("input[name=success_url]",b).val(f),$("input[name=failure_url]",b).val(e),$("input[name=webpay_url]",b).val(g),$("input[name=session_id]",b).val(d),$("#shipping-form",b).attr("action",h)},ShoppingCartView.prototype.renderProducts=function(a,b){for(var c=this.controller.getProducts(),d=0;d<c.length;d++){var e=$(Utils.render(b,c[d]));a.append(e),Utils.processPrice(e)}},ShoppingCartView.prototype.renderTotal=function(a){var b=$(Utils.render(this.total_template,{total:this.controller.getTotal()}));Utils.processPrice(b),a.append(b)};